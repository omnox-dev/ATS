<!DOCTYPE html>
<!--
    Copyright (c) 2026 Omanox-dev
    All Rights Reserved.
    Repository: https://github.com/omanox-dev/ATS
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Omanox-dev">
    <title>AI-Powered ATS Resume Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .prose {
            max-width: 65ch;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 p-4 md:p-8">
    <div class="max-w-6xl mx-auto">

        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">ATS</h1>
            <p class="text-lg text-indigo-300">Analyze Any Resume Against Any Job Description</p>
        </header>

        <!-- Input Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <label for="jobDescription" class="block text-sm font-medium text-gray-300 mb-2">1. Paste Job Description (The Target)</label>
                <textarea id="jobDescription" rows="15" class="w-full p-3 bg-gray-800 border border-gray-700 rounded-md shadow-sm text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Paste the full job description here..."></textarea>
            </div>
            <div>
                <label for="resume" class="block text-sm font-medium text-gray-300 mb-2">2. Paste Resume (The Candidate)</label>
                <textarea id="resume" rows="15" class="w-full p-3 bg-gray-800 border border-gray-700 rounded-md shadow-sm text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Paste the full resume text here..."></textarea>
            </div>
        </div>

        <!-- Action Button -->
        <div class="text-center mb-8">
            <div class="mb-4 md:mb-6 max-w-xl mx-auto text-left">
                <label for="apiKeyInput" class="block text-sm font-medium text-gray-300 mb-2">API Key</label>
                <input id="apiKeyInput" type="password" class="w-full p-3 bg-gray-800 border border-gray-700 rounded-md shadow-sm text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Paste your API key here (kept in sessionStorage for temporary use)">
                <div class="mt-2 flex items-center">
                    <input id="saveApiKey" type="checkbox" class="mr-2" checked>
                    <label for="saveApiKey" class="text-sm text-gray-400">Save key for this session (sessionStorage)</label>
                    <button id="clearApiKey" class="ml-4 text-sm text-red-400 hover:text-red-300">Clear key</button>
                    <label class="ml-4 flex items-center text-sm text-gray-400"><input id="useProxy" type="checkbox" class="mr-2">Use local proxy</label>
                </div>
            </div>

            <button id="analyzeButton" class="bg-indigo-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 text-lg">
                <span id="buttonText">Run ATS Analysis</span>
                <span id="loadingSpinner" class_display_none" style="display: none;">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Analyzing...
                </span>
            </button>
        </div>

        <!-- Output Section -->
        <div id="resultsWrapper" class="bg-gray-800 border border-gray-700 rounded-lg shadow-xl p-6" style="display: none;">
            <h2 class="text-3xl font-bold text-white mb-6 text-center">ATS Analysis Report</h2>
            
            <!-- Score Card -->
            <div id="scoreCard" class="bg-gray-900 p-6 rounded-lg mb-6 text-center shadow-inner">
                <p class="text-lg text-gray-400 mb-2">Overall Match Score</p>
                <p id="overallScore" class="text-7xl font-bold text-indigo-400">0%</p>
            </div>

            <!-- Summary -->
            <div class="mb-6">
                <h3 class="text-xl font-semibold text-white mb-2">Analysis Summary</h3>
                <p id="analysisSummary" class="text-gray-300 prose prose-invert"></p>
            </div>

            <!-- Feedback Breakdown -->
            <div>
                <h3 class="text-xl font-semibold text-white mb-4">Detailed Feedback</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    
                    <!-- Strengths -->
                    <div class="bg-gray-900 p-4 rounded-lg shadow-inner">
                        <h4 class="text-lg font-medium text-green-400 mb-2">Strengths (Keyword Matches)</h4>
                        <ul id="analysisStrengths" class="list-disc list-inside text-gray-300 space-y-1">
                            <!-- JS will populate this -->
                        </ul>
                    </div>
                    
                    <!-- Weaknesses -->
                    <div class="bg-gray-900 p-4 rounded-lg shadow-inner">
                        <h4 class="text-lg font-medium text-red-400 mb-2">Weaknesses / Gaps</h4>
                        <ul id="analysisWeaknesses" class="list-disc list-inside text-gray-300 space-y-1">
                            <!-- JS will populate this -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Raw JSON Toggle -->
            <div class="mt-8">
                <button id="toggleJson" class="text-sm text-indigo-400 hover:text-indigo-300">Show/Hide Raw JSON</button>
                <pre id="rawJson" class="bg-black text-xs text-green-300 p-4 rounded-md overflow-x-auto mt-2" style="display: none;"></pre>
            </div>

            <!-- Suggested Improvements -->
            <div id="improveSection" class="mt-8 bg-gray-900 p-4 rounded-lg" style="display: none;">
                <h3 class="text-xl font-semibold text-white mb-3">Suggested Improvements</h3>
                <p class="text-gray-300 mb-3">Use the suggested changes (missing skills and phrasing) to generate an improved resume tailored to this job description.</p>

                <div class="mb-3">
                    <button id="generateImproveBtn" class="bg-green-600 text-white px-4 py-2 rounded-md mr-2">Generate Improved Resume</button>
                    <button id="downloadImproveBtn" class="bg-gray-700 text-white px-4 py-2 rounded-md" style="display:none;">Download Improved Resume</button>
                    <button id="downloadPdfBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md ml-2" style="display:none;">Download as PDF (Template)</button>
                </div>

                <label class="block text-sm text-gray-400 mb-2">Improved Resume Preview</label>
                <textarea id="improvedResumeText" rows="12" class="w-full p-3 bg-black text-gray-100 rounded-md text-sm" readonly placeholder="Generated improved resume will appear here..." ></textarea>

                <!-- Professional LaTeX Banner -->
                <div id="latexBanner" class="mt-6 bg-gradient-to-r from-indigo-900 to-purple-900 p-6 rounded-lg border border-indigo-500 shadow-2xl text-center" style="display: none;">
                    <div class="flex flex-col items-center">
                        <div class="mb-4">
                            <span class="bg-indigo-500 text-white text-xs font-bold px-2 py-1 rounded-full uppercase tracking-wide">Premium Upgrade</span>
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-2">Want this resume in a professional Resume format?</h3>
                        <p class="text-indigo-200 mb-4 max-w-lg">Share this improved output with me to get a high-quality, recruiter-ready PDF.</p>
                        
                        <div class="flex flex-wrap justify-center gap-4">
                            <a href="https://wa.me/919022826027" target="_blank" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full flex items-center transition-all shadow-lg hover:scale-105">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                                WhatsApp: +91 9022826027
                            </a>
                            <button id="viewDemoResumes" class="bg-indigo-100 hover:bg-white text-indigo-900 font-bold py-3 px-6 rounded-full transition-all border border-indigo-300 shadow-lg">
                                View Demo Resumes
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <!-- Demo Resumes Modal -->
    <div id="demoModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4" style="display: none;">
        <div class="bg-gray-800 border border-gray-700 w-full max-w-4xl max-h-[90vh] overflow-y-auto rounded-xl p-8 shadow-2xl relative">
            <button id="closeDemoModal" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <h2 class="text-3xl font-bold text-white mb-6 border-b border-gray-700 pb-4">Resume Gallery</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Demo 1 -->
                <div class="bg-gray-900 rounded-lg overflow-hidden border border-gray-700">
                    <div class="h-48 bg-gray-700 flex items-center justify-center">
                        <span class="text-gray-400">Preview 1 (Classic)</span>
                    </div>
                    <div class="p-4">
                        <h4 class="font-bold text-white">Classic Academic</h4>
                        <p class="text-sm text-gray-400 mt-2">Perfect for research or formal engineering roles in India.</p>
                    </div>
                </div>
                <!-- Demo 2 -->
                <div class="bg-gray-900 rounded-lg overflow-hidden border border-gray-700">
                    <div class="h-48 bg-gray-700 flex items-center justify-center">
                        <span class="text-gray-400">Preview 2 (Modern)</span>
                    </div>
                    <div class="p-4">
                        <h4 class="font-bold text-white">Modern Professional</h4>
                        <p class="text-sm text-gray-400 mt-2">Clean sidebar, high density, optimized for FAANG recruiters.</p>
                    </div>
                </div>
                <!-- Demo 3 -->
                <div class="bg-gray-900 rounded-lg overflow-hidden border border-gray-700">
                    <div class="h-48 bg-gray-700 flex items-center justify-center">
                        <span class="text-gray-400">Preview 3 (Minimalist)</span>
                    </div>
                    <div class="p-4">
                        <h4 class="font-bold text-white">The "Jake's Resume"</h4>
                        <p class="text-sm text-gray-400 mt-2">The gold standard for ATS readability and simple layout.</p>
                    </div>
                </div>
            </div>

            <div class="mt-8 text-center bg-indigo-900 bg-opacity-30 p-6 rounded-lg">
                <p class="text-indigo-200 mb-4 font-medium italic">"The layout makes all the difference in getting that first interview call."</p>
                <button onclick="window.open('https://wa.me/919022826027', '_blank')" class="bg-green-600 text-white font-bold py-2 px-8 rounded-md hover:bg-green-700">Request Custom Build</button>
            </div>
        </div>
    </div>

        <!-- Disclaimer -->
        <div class="mt-8 text-center text-sm text-gray-400">
            <p class="mb-2">AI can make mistakes. Always review and verify the generated content.</p>
            <p>Use proxy key, but if exhausted, use BYOK (Bring Your Own Key).</p>
        </div>

        <footer class="text-center mt-8 text-sm text-gray-500">
            Built and maintained by <a class="text-indigo-300 hover:underline" href="https://github.com/omanox-dev">Omanox-dev</a>. Repository: <a class="text-indigo-300 hover:underline" href="https://github.com/omanox-dev/ATS">github.com/omanox-dev/ATS</a>
        </footer>

    <script>
        const analyzeButton = document.getElementById('analyzeButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const resultsWrapper = document.getElementById('resultsWrapper');
        const toggleJson = document.getElementById('toggleJson');
        const rawJson = document.getElementById('rawJson');
        const generateImproveBtn = document.getElementById('generateImproveBtn');
        const downloadImproveBtn = document.getElementById('downloadImproveBtn');
        const improvedResumeText = document.getElementById('improvedResumeText');
        const improveSection = document.getElementById('improveSection');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyCheckbox = document.getElementById('saveApiKey');
        const clearApiKeyButton = document.getElementById('clearApiKey');
        const useProxyCheckbox = document.getElementById('useProxy');
        const latexBanner = document.getElementById('latexBanner');
        const demoModal = document.getElementById('demoModal');
        const viewDemoResumes = document.getElementById('viewDemoResumes');
        const closeDemoModal = document.getElementById('closeDemoModal');

        analyzeButton.addEventListener('click', runAnalysis);
        toggleJson.addEventListener('click', () => {
            rawJson.style.display = rawJson.style.display === 'none' ? 'block' : 'none';
        });

        // Modal triggers
        if (viewDemoResumes) viewDemoResumes.addEventListener('click', () => demoModal.style.display = 'flex');
        if (closeDemoModal) closeDemoModal.addEventListener('click', () => demoModal.style.display = 'none');
        window.onclick = (event) => { if (event.target == demoModal) demoModal.style.display = 'none'; };

        // Prefill API key input from sessionStorage when the page loads
        window.addEventListener('DOMContentLoaded', () => {
            try {
                const stored = sessionStorage.getItem('ats_api_key');
                if (stored && apiKeyInput) apiKeyInput.value = stored;
            } catch (e) {
                console.warn('Could not read sessionStorage for API key', e);
            }
        });

        // Clear stored API key when user requests
        if (clearApiKeyButton) {
            clearApiKeyButton.addEventListener('click', (e) => {
                e.preventDefault();
                try {
                    sessionStorage.removeItem('ats_api_key');
                    if (apiKeyInput) apiKeyInput.value = '';
                    if (saveApiKeyCheckbox) saveApiKeyCheckbox.checked = false;
                    alert('API key cleared from session storage.');
                } catch (err) {
                    console.error('Failed to clear API key from sessionStorage', err);
                    alert('Failed to clear key. See console for details.');
                }
            });
        }

        // Improve resume button handlers
        if (generateImproveBtn) generateImproveBtn.addEventListener('click', generateImprovedResume);
        if (downloadImproveBtn) downloadImproveBtn.addEventListener('click', downloadImprovedResume);
        if (downloadPdfBtn) downloadPdfBtn.addEventListener('click', downloadImprovedPdf);

        // Prefill the proxy checkbox state if you want (default off)
        if (useProxyCheckbox) {
            // leave unchecked by default; user can check to route calls through local proxy
        }

        // This is the core logic.
        // It instructs the AI how to behave and what to return.
        const systemPrompt = `
You are a strict, world-class Applicant Tracking System (ATS) simulator. Your sole purpose is to analyze a candidate's RESUME against a provided JOB DESCRIPTION.

You must perform the following actions:
1.  **Parseability Check:** First, check the RESUME for any obvious parsing errors like columns, tables, or special characters. Assume plain text is 100% parseable.
2.  **Keyword Matching:** Scour the RESUME for direct keyword matches from the JOB DESCRIPTION. Focus on skills, technologies, and required experience.
3.  **Metric Analysis:** Identify and extract quantifiable metrics from the RESUME (e.g., "5 hours", "12 reports", "2 days", "20% increase"). This is extremely important.
4.  **Scoring:** Provide an "overallScore" from 0 to 100, representing the percentage of the JOB DESCRIPTION that is covered by the RESUME.
5.  **Feedback:** Provide a "summary" of your findings, a list of "strengths" (direct keyword/concept matches), and a list of "weaknesses" (missing keywords/experience).

You MUST return your analysis ONLY in the specified JSON format. Do not include any other text.
        `;

        // This is the JSON "schema" we will force the model to follow.
        // This makes the response predictable and easy to parse on the frontend.
        const jsonSchema = {
            type: "OBJECT",
            properties: {
                "overallScore": { 
                    type: "NUMBER",
                    description: "A score from 0-100 representing the resume's match to the job description."
                },
                "parseabilityScore": {
                    type: "NUMBER",
                    description: "A score from 0-100. Assume 100 for plain text."
                },
                "summary": {
                    type: "STRING",
                    description: "A 2-3 sentence executive summary of the match."
                },
                "strengths": {
                    type: "ARRAY",
                    items: {
                        type: "STRING",
                        description: "A specific keyword or concept from the resume that matches the job description."
                    }
                },
                "weaknesses": {
                    type: "ARRAY",
                    items: {
                        type: "STRING",
                        description: "A specific keyword or requirement from the job description that is missing from the resume."
                    }
                }
            },
            required: ["overallScore", "parseabilityScore", "summary", "strengths", "weaknesses"]
        };

        async function runAnalysis() {
            const jobDescription = document.getElementById('jobDescription').value;
            const resume = document.getElementById('resume').value;

            if (!jobDescription || !resume) {
                alert('Please paste both the Job Description and the Resume.');
                return;
            }

            setLoading(true);

            // Construct the user prompt
            const userQuery = `
Here is the JOB DESCRIPTION:
---
${jobDescription}
---

Here is the RESUME:
---
${resume}
---

Please perform the ATS analysis now.
            `;
            
            // API key handling: read from the input or sessionStorage unless using a local proxy
            const useProxy = useProxyCheckbox && useProxyCheckbox.checked;

            let apiKey = sessionStorage.getItem('ats_api_key') || '';
            if (apiKeyInput && apiKeyInput.value.trim()) {
                apiKey = apiKeyInput.value.trim();
                if (saveApiKeyCheckbox && saveApiKeyCheckbox.checked) {
                    sessionStorage.setItem('ats_api_key', apiKey);
                }
            }

            let apiUrl;
            if (useProxy) {
                // route to local proxy which keeps the server-side key
                apiUrl = '/api/generate';
            } else {
                if (!apiKey) {
                    setLoading(false);
                    alert('Please enter your API key in the API Key field or enable the local proxy.');
                    return;
                }
                apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${encodeURIComponent(apiKey)}`;
            }

            const payload = {
                contents: [{ 
                    role: "user",
                    parts: [{ text: userQuery }] 
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: jsonSchema,
                }
            };
            
            try {
                // Implement exponential backoff for retries
                let response;
                let delay = 1000;
                for (let i = 0; i < 5; i++) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break; // Success
                    } else if (response.status === 429 || response.status >= 500) {
                        // Throttling or server error, wait and retry
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    } else {
                        // Other client-side error — break to handle below
                        break;
                    }
                }

                // If we failed and it was a Not Found (likely invalid model or key),
                // attempt a fallback to the local proxy if not already using it.
                if (!response || !response.ok) {
                    if (!useProxy && response && response.status === 404) {
                        console.info('Direct API returned 404 — retrying via local proxy /api/generate');
                        // Switch to proxy and try once
                        apiUrl = '/api/generate';
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) {
                            const txt = await response.text();
                            throw new Error(`Proxy fallback failed: ${response.status} ${txt}`);
                        }
                    } else {
                        // No viable retry path
                        const statusText = response ? response.statusText : 'no response';
                        throw new Error(`API Error: ${statusText}`);
                    }
                }
                
                const result = await response.json();
                
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const analysis = JSON.parse(jsonText);
                    // store last inputs for the improve-resume flow
                    window._lastJobDescription = jobDescription;
                    window._lastResume = resume;
                    window._lastAnalysis = analysis;
                    displayResults(analysis, jsonText);
                } else {
                    console.error('Unexpected API response structure:', result);
                    alert('Error: Could not parse the analysis from the API response.');
                }

            } catch (error) {
                console.error('Error during analysis:', error);
                alert(`An error occurred: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }

        function displayResults(analysis, jsonText) {
            document.getElementById('overallScore').textContent = `${analysis.overallScore}%`;
            document.getElementById('analysisSummary').textContent = analysis.summary;
            
            const strengthsList = document.getElementById('analysisStrengths');
            strengthsList.innerHTML = ''; // Clear previous results
            analysis.strengths.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                strengthsList.appendChild(li);
            });

            const weaknessesList = document.getElementById('analysisWeaknesses');
            weaknessesList.innerHTML = ''; // Clear previous results
            analysis.weaknesses.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                weaknessesList.appendChild(li);
            });

            rawJson.textContent = jsonText;
            resultsWrapper.style.display = 'block';
            // Show improve section and populate missing-skills list if available
            if (improveSection) improveSection.style.display = 'block';
            if (latexBanner) latexBanner.style.display = 'block';
        }

        function setLoading(isLoading) {
            if (isLoading) {
                buttonText.style.display = 'none';
                loadingSpinner.style.display = 'inline-block';
                analyzeButton.disabled = true;
            } else {
                buttonText.style.display = 'inline-block';
                loadingSpinner.style.display = 'none';
                analyzeButton.disabled = false;
            }
        }

        // Generate an improved resume using the model (via proxy or direct)
        async function generateImprovedResume() {
            if (!window._lastJobDescription || !window._lastResume || !window._lastAnalysis) {
                alert('Please run the ATS analysis first so the improvement can be tailored to the job.');
                return;
            }

            setLoading(true);
            generateImproveBtn.disabled = true;
            generateImproveBtn.textContent = 'Generating...';

            // Assemble a prompt that instructs the model to produce an improved resume text
            const prompt = `You are an expert resume writer and ATS optimizer. Improve the candidate's RESUME so it better matches the JOB DESCRIPTION. Be concise but preserve factual content. Add missing keywords and skills (without inventing false employment history). Where appropriate, suggest measurable metrics or rephrase achievements into results-oriented bullet points. Output only the improved resume in plain text (no JSON, no commentary).

JOB DESCRIPTION:
---
${window._lastJobDescription}
---

CURRENT RESUME:
---
${window._lastResume}
---

MISSING / WEAKNESSES (from ATS):
---
${(window._lastAnalysis.weaknesses || []).join(', ')}
---

Provide a clean resume formatted as plain text. Keep names and dates as in the original where possible.
`;

            // Determine apiUrl similar to runAnalysis
            const useProxy = useProxyCheckbox && useProxyCheckbox.checked;
            let apiKey = sessionStorage.getItem('ats_api_key') || '';
            if (apiKeyInput && apiKeyInput.value.trim()) apiKey = apiKeyInput.value.trim();

            let apiUrl;
            if (useProxy) {
                apiUrl = '/api/generate';
            } else {
                if (!apiKey) {
                    setLoading(false);
                    generateImproveBtn.disabled = false;
                    generateImproveBtn.textContent = 'Generate Improved Resume';
                    alert('Please enter your API key in the API Key field or enable the local proxy.');
                    return;
                }
                apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${encodeURIComponent(apiKey)}`;
            }

            const payload = {
                contents: [{ role: 'user', parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: 'You are an expert resume writer.' }] },
                generationConfig: {
                    responseMimeType: 'text/plain',
                }
            };

            try {
                const resp = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!resp.ok) {
                    const txt = await resp.text();
                    throw new Error(`Request failed: ${resp.status} ${txt}`);
                }

                const result = await resp.json();

                // The model may return text in different shapes depending on proxy; try to extract
                let generated = '';
                try {
                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts[0].text) {
                        generated = result.candidates[0].content.parts[0].text;
                    } else if (typeof result === 'string') {
                        generated = result;
                    } else if (result.text) {
                        generated = result.text;
                    } else {
                        generated = JSON.stringify(result, null, 2);
                    }
                } catch (e) {
                    generated = JSON.stringify(result, null, 2);
                }

                improvedResumeText.value = generated;
                downloadImproveBtn.style.display = 'inline-block';
                if (downloadPdfBtn) downloadPdfBtn.style.display = 'inline-block';
            } catch (err) {
                console.error('Error generating improved resume', err);
                alert('Failed to generate improved resume: ' + err.message);
            } finally {
                setLoading(false);
                generateImproveBtn.disabled = false;
                generateImproveBtn.textContent = 'Generate Improved Resume';
            }
        }

        // Download the improved resume as a .txt file
        function downloadImprovedResume() {
            const text = improvedResumeText.value || '';
            if (!text) {
                alert('No improved resume to download. Generate one first.');
                return;
            }

            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'improved_resume.txt';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        // Create a simple, clean HTML resume template and request PDF from server (or fallback to HTML download)
        async function downloadImprovedPdf() {
            const text = improvedResumeText.value || '';
            if (!text) {
                alert('No improved resume to download. Generate one first.');
                return;
            }

            // Build a basic HTML template. You can customize styles here to your taste.
            const html = `<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Improved Resume</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; color:#111; padding:40px; }
    .container { max-width:800px; margin:0 auto; }
    h1{ font-size:26px; margin-bottom:6px }
    h2{ font-size:16px; margin-top:18px; color:#374151 }
    p, li { font-size:14px; line-height:1.45 }
    .section { margin-top:12px }
    .skills { display:flex; flex-wrap:wrap; gap:8px }
    .skill { background:#eef2ff; padding:6px 10px; border-radius:6px; color:#312e81 }
    pre { white-space:pre-wrap; font-family:inherit }
  </style>
</head>
<body>
  <div class="container">
    <!-- We assume the improved resume is plain text; try to split into lines and headings -->
    <h1>Candidate Resume</h1>
    <pre>${escapeHtml(text)}</pre>
  </div>
</body>
</html>`;

            const useProxy = useProxyCheckbox && useProxyCheckbox.checked;
            if (useProxy) {
                try {
                    const resp = await fetch('/api/render-pdf', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ html })
                    });

                    if (!resp.ok) {
                        const txt = await resp.text();
                        throw new Error(`PDF render failed: ${resp.status} ${txt}`);
                    }

                    const blob = await resp.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'improved_resume.pdf';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                } catch (err) {
                    console.error('Failed to download PDF', err);
                    alert('Failed to render PDF on server: ' + err.message + '\nYou can download the HTML version as a fallback.');
                    downloadHtmlFallback(html);
                }
            } else {
                // No proxy: download HTML file as fallback
                downloadHtmlFallback(html);
            }
        }

        function downloadHtmlFallback(html) {
            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'improved_resume.html';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        function escapeHtml(unsafe) {
            return unsafe.replace(/[&<>\"']/g, function (c) {
                return {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[c];
            });
        }
    </script>
</body>
</html>
